<div class="row">
  <div class="col-3">
    <section>
      <app-card>
        <app-card-title data-testid="title">Search and Filter</app-card-title>
        <app-card-content>
          <app-resolve-entity-form (whenSearch)="search($event)"></app-resolve-entity-form>
        </app-card-content>
      </app-card>
    </section>
  </div>

  <div class="col-9">
    <mat-spinner *ngIf="loading" class="spinner" diameter="30"></mat-spinner>
    <mat-card *ngIf="showError">
      {{ errorMessage }}
    </mat-card>
    <app-card *ngIf="!showError && !loading && entitySearchResults">
      <app-card-title *ngIf="!showError && entitySearchResults.length == 0">
        No results to display
      </app-card-title>
      <app-card-title *ngIf="entitySearchResults.length" data-testid="matching-entities-number">
        <ng-container [ngPlural]="entitySearchResults.length">
          {{ entitySearchResults.length }}
          <ng-template ngPluralCase="=1">entity</ng-template>
          <ng-template ngPluralCase="other">entities</ng-template>
          found
        </ng-container>
      </app-card-title>
      <app-card-content *ngIf="entitySearchResults.length > 0">
        <table
          class="search-entities"
          mat-table
          [dataSource]="dataSource"
          matSort
          matSortDisableClear
        >
          <ng-container matColumnDef="entityName">
            <th mat-header-cell *matHeaderCellDef>Entity Name</th>
            <td mat-cell *matCellDef="let attribute" data-testid="entity-name">
              <span>{{ attribute.name }}</span>
              <div
                *ngIf="isValuePresent(attribute.entityId)"
                class="action-button"
                data-testid="action-buttons"
              >
                <button
                  mat-stroked-button
                  (click)="navigateToEntityDetails(attribute.entityId)"
                  data-testid="view-entity"
                >
                  View existing record
                </button>
              </div>
              <div *ngIf="!isValuePresent(attribute.entityId)" class="action-button">
                <button
                  *ngIf="isAllowed$ | async; else notAllowed"
                  mat-stroked-button
                  (click)="navigateToViewMatchCandidate(attribute.dunsNumber)"
                  data-testid="create-entity"
                >
                  Create
                </button>
                <ng-template #notAllowed>
                  <button class="disabled" data-testid="create-entity" disabled mat-stroked-button>
                    Create
                  </button>
                </ng-template>
                <mat-spinner *ngIf="loading" class="spinner" diameter="20"></mat-spinner>
              </div>
            </td>
          </ng-container>
          <ng-container matColumnDef="entityIds">
            <th mat-header-cell *matHeaderCellDef>Entity Ids</th>
            <td mat-cell *matCellDef="let attribute" data-testid="entityIds">
              <span *ngIf="isValuePresent(attribute.entityId)"
                >Greensill ID: {{ attribute.entityId }} <br
              /></span>
              <span *ngIf="isValuePresent(attribute.dunsNumber)"
                >DUNS No: {{ attribute.dunsNumber }} <br
              /></span>
            </td>
          </ng-container>
          <ng-container matColumnDef="address">
            <th mat-header-cell *matHeaderCellDef>Address</th>
            <td mat-cell *matCellDef="let attribute" data-testid="address">
              <span *ngIf="isValuePresent(attribute.primaryAddress.line1)"
                >{{ attribute.primaryAddress.line1 }}, <br
              /></span>
              <span *ngIf="isValuePresent(attribute.primaryAddress.line2)"
                >{{ attribute.primaryAddress.line2 }}, <br
              /></span>

              <span *ngIf="isValuePresent(attribute.primaryAddress.city)"
                >{{ attribute.primaryAddress.city }}, <br
              /></span>
              <span *ngIf="isValuePresent(attribute.primaryAddress.postalCode)"
                >{{ attribute.primaryAddress.postalCode }}<br
              /></span>
              <span *ngIf="isValuePresent(attribute.primaryAddress.regionName); else showRegion">
                {{ attribute.primaryAddress.regionName }}<br />
              </span>
              <ng-template #showRegion> {{ attribute.primaryAddress.region }}<br /> </ng-template>
              <span *ngIf="isValuePresent(attribute.primaryAddress.countryName)">{{
                attribute.primaryAddress.countryName
              }}</span>
            </td>
          </ng-container>
          <ng-container matColumnDef="confidanceScore">
            <th mat-header-cell *matHeaderCellDef>Confidence Score</th>
            <td mat-cell *matCellDef="let attribute" data-testid="confidanceScore">
              {{ attribute.matchScore }}
            </td>
          </ng-container>
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let attribute" data-testid="status">
              {{ attribute.status | titlecaseFormat }}
            </td>
          </ng-container>
          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr
            mat-row
            [attr.data-testid]="'attribute-row-' + i"
            *matRowDef="let row; columns: displayedColumns; let i = index; let entry"
            [ngClass]="{ 'verdi-data-style': entry.entityId }"
          ></tr>
        </table>
      </app-card-content>
    </app-card>
  </div>
</div>
